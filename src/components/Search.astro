---
// Terminal-style fullscreen search using Pagefind
---

<div
  class="search-terminal"
  id="search-overlay"
  role="dialog"
  aria-modal="true"
  aria-label="Buscar artículos"
>
  <div class="terminal-window">
    <div class="terminal-titlebar">
      <span class="terminal-title">tengoping — buscar</span>
      <button class="terminal-close" id="search-close" aria-label="Cerrar búsqueda">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="terminal-body">
      <span id="search-help" class="sr-only">
        Escribe para buscar artículos. Los resultados aparecen debajo del prompt.
      </span>
      <div class="terminal-prompt-line">
        <span class="prompt-symbol">$</span>
        <span class="prompt-cmd">grep -ri "</span><span
          class="prompt-query"
          id="search-query-mirror"></span><span class="prompt-cmd">" /blog/</span><span
          class="prompt-cursor">▌</span
        >
      </div>
      <div id="search-pagefind"></div>
    </div>
    <div class="terminal-status" id="search-status">
      <span class="status-results" id="search-results-count" aria-live="polite" aria-atomic="true"
      ></span>
      <span class="status-keys">ESC cerrar · Ctrl+K buscar</span>
    </div>
  </div>
</div>

<script is:inline>
  let globalListenersRegistered = false;

  function initSearch() {
    const overlay = document.getElementById('search-overlay');
    const closeBtn = document.getElementById('search-close');
    const queryMirror = document.getElementById('search-query-mirror');
    const resultsCount = document.getElementById('search-results-count');
    let pagefindLoaded = false;

    function loadPagefind() {
      if (pagefindLoaded) return;
      pagefindLoaded = true;

      import('/pagefind/pagefind-ui.js')
        .then(function () {
          if (typeof window.PagefindUI === 'function') {
            new window.PagefindUI({
              element: '#search-pagefind',
              showSubResults: true,
              showImages: false,
              translations: {
                placeholder: 'buscar artículos...',
                zero_results: 'sin resultados para "[SEARCH_TERM]"',
                many_results: '[COUNT] resultados',
                one_result: '1 resultado',
                searching: 'buscando...',
              },
            });
            setTimeout(function () {
              const input = document.querySelector('.pagefind-ui__search-input');
              if (input) {
                input.setAttribute('aria-label', 'Buscar artículos');
                input.setAttribute('aria-describedby', 'search-help');
                input.focus();
                input.addEventListener('input', function () {
                  if (queryMirror) queryMirror.textContent = this.value;
                  updateResultCount();
                });
              }
            }, 100);
          } else {
            throw new Error('PagefindUI not available');
          }
        })
        .catch(function () {
          const container = document.getElementById('search-pagefind');
          if (container) {
            container.innerHTML =
              '<p class="terminal-error">error: índice no encontrado. Ejecuta <code>npm run build</code> primero.</p>';
          }
        });
    }

    function updateResultCount() {
      setTimeout(function () {
        const msg = document.querySelector('.pagefind-ui__message');
        if (msg && resultsCount) {
          resultsCount.textContent = msg.textContent;
        }
      }, 300);
    }

    let lastFocusedElement = null;

    function trapFocus(e) {
      if (!overlay || !overlay.classList.contains('active')) return;
      if (e.key !== 'Tab') return;

      const focusable = overlay.querySelectorAll(
        'input, button, a[href], [tabindex]:not([tabindex="-1"])'
      );
      if (!focusable.length) return;

      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      if (e.shiftKey) {
        if (document.activeElement === first) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }

    function openSearch() {
      lastFocusedElement = document.activeElement;
      if (overlay) overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      loadPagefind();
      setTimeout(function () {
        const input = document.querySelector('.pagefind-ui__search-input');
        if (input) input.focus();
      }, 150);
    }

    function closeSearch() {
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
      if (lastFocusedElement) lastFocusedElement.focus();
    }

    document.querySelectorAll('[data-search-trigger]').forEach(function (btn) {
      btn.addEventListener('click', openSearch);
    });

    if (!globalListenersRegistered) {
      if (closeBtn) closeBtn.onclick = closeSearch;
      if (overlay)
        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) closeSearch();
        });

      document.addEventListener('keydown', function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          openSearch();
        }
        if (e.key === 'Escape') closeSearch();
        trapFocus(e);
      });

      globalListenersRegistered = true;
    }
  }

  initSearch();
  document.addEventListener('astro:after-swap', initSearch);
</script>

<style>
  .search-terminal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: var(--search-backdrop);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    --search-backdrop: rgba(0, 0, 0, 0.5);
  }

  :global([data-theme='dark']) .search-terminal {
    --search-backdrop: rgba(0, 0, 0, 0.85);
  }

  .search-terminal.active {
    display: flex;
  }

  .terminal-window {
    width: 90vw;
    max-width: 800px;
    height: 80vh;
    max-height: 700px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    animation: terminalOpen 0.2s ease-out;
    color: var(--color-text);
  }

  @keyframes terminalOpen {
    from {
      opacity: 0;
      transform: scale(0.96);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .terminal-titlebar {
    display: flex;
    align-items: center;
    padding: 0.65rem 1rem;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .terminal-title {
    flex: 1;
    text-align: center;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    font-family: var(--font-body, 'JetBrains Mono', monospace);
  }

  .terminal-close {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: 0.2rem;
    line-height: 1;
    transition: color 0.15s;
  }

  .terminal-close:hover {
    color: var(--color-text);
  }

  .terminal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.25rem;
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) var(--color-bg);
  }

  .terminal-body::-webkit-scrollbar {
    width: 6px;
  }

  .terminal-body::-webkit-scrollbar-track {
    background: var(--color-bg);
  }

  .terminal-body::-webkit-scrollbar-thumb {
    background: var(--color-border);
  }

  .terminal-body::-webkit-scrollbar-thumb:hover {
    background: var(--color-primary);
  }

  .terminal-prompt-line {
    font-family: var(--font-body, 'JetBrains Mono', monospace);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    color: var(--color-text-muted);
    white-space: nowrap;
    overflow: hidden;
  }

  .prompt-symbol {
    color: var(--color-primary);
    font-weight: 700;
    margin-right: 0.5ch;
  }

  .prompt-cmd {
    color: var(--color-text-muted);
  }

  .prompt-query {
    color: var(--color-text);
    font-weight: 600;
  }

  .prompt-cursor {
    color: var(--color-primary);
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }

  .terminal-error {
    color: #f85149;
    padding: 0.5rem 0;
    font-family: var(--font-body, 'JetBrains Mono', monospace);
    font-size: 0.85rem;
  }

  .terminal-error code {
    color: var(--color-primary);
    background: var(--color-bg-secondary);
    padding: 0.15rem 0.4rem;
  }

  .terminal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1.25rem;
    background: var(--color-bg-secondary);
    border-top: 1px solid var(--color-border);
    font-family: var(--font-body, 'JetBrains Mono', monospace);
    font-size: 0.75rem;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .status-results {
    color: var(--color-primary);
  }

  .status-keys {
    color: var(--color-text-muted);
  }

  @media (max-width: 768px) {
    .search-terminal {
      padding: 0;
    }

    .terminal-window {
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      border: none;
    }

    .terminal-prompt-line {
      font-size: 0.8rem;
    }
  }
</style>
