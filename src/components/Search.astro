---
// Search modal using Pagefind
---

<div class="search-overlay" id="search-overlay">
  <div class="search-container">
    <div class="search-header">
      <span><span class="search-prompt">tengoping:~$</span> buscar</span>
      <button class="search-close" id="search-close" aria-label="Cerrar b&uacute;squeda">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div id="search-pagefind"></div>
  </div>
</div>

<script is:inline>
  function initSearch() {
    var overlay = document.getElementById('search-overlay');
    var closeBtn = document.getElementById('search-close');
    var pagefindLoaded = false;

    function loadPagefind() {
      if (pagefindLoaded) return;
      pagefindLoaded = true;

      import('/pagefind/pagefind-ui.js')
        .then(function(pagefind) {
          new pagefind.PagefindUI({
            element: '#search-pagefind',
            showSubResults: true,
            translations: {
              placeholder: '>_ buscar articulos...',
              zero_results: 'No se encontraron resultados para "[SEARCH_TERM]"',
              many_results: '[COUNT] resultados encontrados',
              one_result: '1 resultado encontrado',
              searching: 'Buscando...',
            },
          });
          setTimeout(function() {
            var input = document.querySelector('.pagefind-ui__search-input');
            if (input) {
              input.setAttribute('aria-label', 'Buscar art√≠culos');
              input.focus();
            }
          }, 100);
        })
        .catch(function() {
          var container = document.getElementById('search-pagefind');
          if (container) {
            container.innerHTML = '<p style="padding: 1rem; color: var(--color-text-secondary);">La b&uacute;squeda est&aacute; disponible tras ejecutar <code>npm run build</code>.</p>';
          }
        });
    }

    function openSearch() {
      if (overlay) overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      loadPagefind();
    }

    function closeSearch() {
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    document.querySelectorAll('[data-search-trigger]').forEach(function(btn) {
      btn.addEventListener('click', openSearch);
    });

    if (closeBtn) closeBtn.addEventListener('click', closeSearch);

    if (overlay) overlay.addEventListener('click', function(e) {
      if (e.target === overlay) closeSearch();
    });

    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      if (e.key === 'Escape') closeSearch();
    });
  }

  initSearch();
  document.addEventListener('astro:after-swap', initSearch);
</script>

<style>
  .search-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
    font-weight: 600;
    color: var(--color-text);
  }

  .search-prompt {
    color: var(--color-primary);
  }

  .search-close {
    background: none;
    border: 1px solid transparent;
    cursor: pointer;
    color: var(--color-text-secondary);
    padding: 0.25rem;
    transition: color 0.2s;
  }

  .search-close:hover {
    color: var(--color-text);
    border-color: var(--color-border);
  }

  #search-pagefind {
    padding: 1rem;
    max-height: 60vh;
    overflow-y: auto;
  }
</style>
