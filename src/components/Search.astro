---
// Terminal-style fullscreen search using Pagefind
---

<div class="search-terminal" id="search-overlay">
  <div class="terminal-window">
    <div class="terminal-titlebar">
      <span class="terminal-title">tengoping — buscar</span>
      <button class="terminal-close" id="search-close" aria-label="Cerrar búsqueda">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="terminal-body">
      <div class="terminal-prompt-line">
        <span class="prompt-symbol">$</span>
        <span class="prompt-cmd">grep -ri "</span><span class="prompt-query" id="search-query-mirror"></span><span class="prompt-cmd">" /blog/</span>
      </div>
      <div id="search-pagefind"></div>
    </div>
    <div class="terminal-status" id="search-status">
      <span class="status-results" id="search-results-count"></span>
      <span class="status-keys">ESC cerrar · Ctrl+K buscar</span>
    </div>
  </div>
</div>

<script is:inline>
  function initSearch() {
    var overlay = document.getElementById('search-overlay');
    var closeBtn = document.getElementById('search-close');
    var queryMirror = document.getElementById('search-query-mirror');
    var resultsCount = document.getElementById('search-results-count');
    var pagefindLoaded = false;

    function loadPagefind() {
      if (pagefindLoaded) return;
      pagefindLoaded = true;

      import('/pagefind/pagefind-ui.js')
        .then(function() {
          if (typeof window.PagefindUI === 'function') {
            new window.PagefindUI({
              element: '#search-pagefind',
              showSubResults: true,
              showImages: false,
              translations: {
                placeholder: 'buscar articulos...',
                zero_results: 'sin resultados para "[SEARCH_TERM]"',
                many_results: '[COUNT] resultados',
                one_result: '1 resultado',
                searching: 'buscando...',
              },
            });
            setTimeout(function() {
              var input = document.querySelector('.pagefind-ui__search-input');
              if (input) {
                input.setAttribute('aria-label', 'Buscar artículos');
                input.focus();
                input.addEventListener('input', function() {
                  if (queryMirror) queryMirror.textContent = this.value;
                  updateResultCount();
                });
              }
            }, 100);
          } else {
            throw new Error('PagefindUI not available');
          }
        })
        .catch(function() {
          var container = document.getElementById('search-pagefind');
          if (container) {
            container.innerHTML = '<p class="terminal-error">error: índice no encontrado. Ejecuta <code>npm run build</code> primero.</p>';
          }
        });
    }

    function updateResultCount() {
      setTimeout(function() {
        var msg = document.querySelector('.pagefind-ui__message');
        if (msg && resultsCount) {
          resultsCount.textContent = msg.textContent;
        }
      }, 300);
    }

    function openSearch() {
      if (overlay) overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      loadPagefind();
      setTimeout(function() {
        var input = document.querySelector('.pagefind-ui__search-input');
        if (input) input.focus();
      }, 150);
    }

    function closeSearch() {
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    document.querySelectorAll('[data-search-trigger]').forEach(function(btn) {
      btn.addEventListener('click', openSearch);
    });

    if (closeBtn) closeBtn.addEventListener('click', closeSearch);

    if (overlay) overlay.addEventListener('click', function(e) {
      if (e.target === overlay) closeSearch();
    });

    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      if (e.key === 'Escape') closeSearch();
    });
  }

  initSearch();
  document.addEventListener('astro:after-swap', initSearch);
</script>

<style>
  .search-terminal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .search-terminal.active {
    display: flex;
  }

  .terminal-window {
    width: 90vw;
    max-width: 800px;
    height: 80vh;
    max-height: 700px;
    background: #0D1117;
    border: 1px solid #30363D;
    display: flex;
    flex-direction: column;
    animation: terminalOpen 0.2s ease-out;
    color: #E6EDF3;
  }

  @keyframes terminalOpen {
    from { opacity: 0; transform: scale(0.96); }
    to { opacity: 1; transform: scale(1); }
  }

  .terminal-titlebar {
    display: flex;
    align-items: center;
    padding: 0.65rem 1rem;
    background: #161B22;
    border-bottom: 1px solid #30363D;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .terminal-title {
    flex: 1;
    text-align: center;
    font-size: 0.8rem;
    color: #8B949E;
    font-family: var(--font-body, 'JetBrains Mono', monospace);
  }

  .terminal-close {
    background: none;
    border: none;
    cursor: pointer;
    color: #8B949E;
    padding: 0.2rem;
    line-height: 1;
    transition: color 0.15s;
  }

  .terminal-close:hover {
    color: #E6EDF3;
  }

  .terminal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.25rem;
    scrollbar-width: thin;
    scrollbar-color: #30363D #0D1117;
  }

  .terminal-body::-webkit-scrollbar {
    width: 6px;
  }

  .terminal-body::-webkit-scrollbar-track {
    background: #0D1117;
  }

  .terminal-body::-webkit-scrollbar-thumb {
    background: #30363D;
  }

  .terminal-body::-webkit-scrollbar-thumb:hover {
    background: #58D5A2;
  }

  .terminal-prompt-line {
    font-family: var(--font-body, 'JetBrains Mono', monospace);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    color: #8B949E;
    white-space: nowrap;
    overflow: hidden;
  }

  .prompt-symbol {
    color: #58D5A2;
    font-weight: 700;
    margin-right: 0.5ch;
  }

  .prompt-cmd {
    color: #8B949E;
  }

  .prompt-query {
    color: #E6EDF3;
    font-weight: 600;
  }

  .terminal-error {
    color: #F85149;
    padding: 0.5rem 0;
    font-family: var(--font-body, 'JetBrains Mono', monospace);
    font-size: 0.85rem;
  }

  .terminal-error code {
    color: #58D5A2;
    background: #161B22;
    padding: 0.15rem 0.4rem;
  }

  .terminal-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1.25rem;
    background: #161B22;
    border-top: 1px solid #30363D;
    font-family: var(--font-body, 'JetBrains Mono', monospace);
    font-size: 0.75rem;
    color: #8B949E;
    flex-shrink: 0;
  }

  .status-results {
    color: #58D5A2;
  }

  .status-keys {
    color: #6E7681;
  }

  @media (max-width: 768px) {
    .search-terminal {
      padding: 0;
    }

    .terminal-window {
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      border: none;
    }

    .terminal-prompt-line {
      font-size: 0.8rem;
    }
  }
</style>
