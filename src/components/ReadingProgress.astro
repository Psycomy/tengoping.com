<div class="reading-progress-bar" id="reading-progress" aria-hidden="true"></div>
<button class="back-to-top" id="back-to-top" aria-label="Volver arriba" title="Volver arriba"
  >↑</button
>

<script>
  let scrollHandler: (() => void) | null = null;

  function init() {
    const progressBar = document.getElementById('reading-progress');
    const backToTop = document.getElementById('back-to-top');

    if (!progressBar || !backToTop) return;

    const pb = progressBar;
    const bt = backToTop;
    const originalTitle = document.title;
    const readingTimeEl = document.querySelector<HTMLElement>('.reading-time');
    const totalMinutes = readingTimeEl ? parseInt(readingTimeEl.dataset.minutes ?? '0', 10) : 0;
    const originalReadingText = readingTimeEl?.textContent ?? '';

    // Remove previous scroll listener
    if (scrollHandler) {
      window.removeEventListener('scroll', scrollHandler);
    }

    scrollHandler = function () {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
      pb.style.width = `${progress}%`;
      bt.classList.toggle('visible', scrollTop > 300);

      if (progress > 2 && progress < 98) {
        document.title = `[${Math.round(progress)}%] ${originalTitle}`;
      } else {
        document.title = originalTitle;
      }

      if (readingTimeEl && totalMinutes > 0) {
        if (progress >= 98) {
          readingTimeEl.textContent = '< 1 min';
        } else if (progress > 5) {
          const remaining = Math.round(totalMinutes * (1 - progress / 100));
          readingTimeEl.textContent =
            remaining === 1 ? '~1 min restante' : `~${remaining} min restantes`;
        } else {
          readingTimeEl.textContent = originalReadingText;
        }
      }
    };

    window.addEventListener('scroll', scrollHandler, { passive: true });

    // onclick overwrites on each init — no accumulation
    bt.onclick = () => {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      window.scrollTo({ top: 0, behavior: prefersReduced ? 'instant' : 'smooth' });
    };

    scrollHandler(); // initial state
  }

  init();
  document.addEventListener('astro:after-swap', init);
</script>

<style>
  .reading-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 3px;
    background: var(--color-primary);
    z-index: 1001;
    transition: width 0.1s linear;
  }

  .back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface);
    color: var(--color-primary);
    border: 1px solid var(--color-border);
    font-size: 1.25rem;
    font-family: var(--font-mono);
    font-weight: 700;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 0.2s ease,
      background-color 0.2s ease,
      color 0.2s ease;
    z-index: 100;
  }

  .back-to-top.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .back-to-top:hover {
    background: var(--color-primary);
    color: var(--color-bg);
    border-color: var(--color-primary);
  }
</style>
