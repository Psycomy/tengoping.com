---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getUniqueCategories, slugify } from '@utils/helpers';

const categoryMeta: Record<string, { icon: string; description: string }> = {
  'Linux': {
    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="7" y1="8" x2="17" y2="8"/><line x1="7" y1="12" x2="13" y2="12"/><line x1="7" y1="16" x2="10" y2="16"/></svg>`,
    description: 'Administración, configuración y buenas prácticas en sistemas Linux',
  },
  'Automatización': {
    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/><line x1="14" y1="4" x2="10" y2="20"/></svg>`,
    description: 'Scripts, herramientas y flujos para automatizar tareas repetitivas',
  },
  'Opinión': {
    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
    description: 'Reflexiones y análisis sobre tendencias en tecnología e infraestructura',
  },
  'Redes': {
    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="2"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><line x1="6" y1="7" x2="10.5" y2="10.5"/><line x1="18" y1="7" x2="13.5" y2="10.5"/><line x1="6" y1="17" x2="10.5" y2="13.5"/><line x1="18" y1="17" x2="13.5" y2="13.5"/></svg>`,
    description: 'Configuración de redes, protocolos y seguridad perimetral',
  },
};

const posts = await getCollection('blog', ({ data }) => !data.draft);
const categories = getUniqueCategories(posts);
const categoryCounts = categories.map((cat) => {
  const catPosts = posts.filter((p) => p.data.category === cat);
  const tags = [...new Set(catPosts.flatMap((p) => p.data.tags))].sort();
  return {
    name: cat,
    slug: slugify(cat),
    count: catPosts.length,
    tags,
    meta: categoryMeta[cat],
  };
});
---

<BaseLayout title="Categorías" description="Todas las categorías del blog">
  <section class="container page-section">
    <h1>Categorías</h1>
    <div class="categories-grid">
      {categoryCounts.map((cat) => (
        <a href={`/categorias/${cat.slug}`} class="category-card card-hover">
          {cat.meta?.icon && <span class="category-icon" set:html={cat.meta.icon} />}
          <h2>{cat.name}</h2>
          {cat.meta?.description && <p class="category-desc">{cat.meta.description}</p>}
          <div class="card-tags">
            {cat.tags.map((tag) => (
              <span class="badge badge-tag">{tag}</span>
            ))}
          </div>
          <span class="count">{cat.count} {cat.count === 1 ? 'artículo' : 'artículos'}</span>
        </a>
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  .page-section { padding: 3rem 0 4rem; }
  .page-section h1 { text-align: center; margin-bottom: 2rem; }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1.5rem;
  }

  .category-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 2rem 1.5rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    text-align: center;
  }

  .category-icon {
    display: flex;
    color: var(--color-primary);
  }

  .category-card h2 {
    font-size: 1.25rem;
    color: var(--color-text);
    margin: 0;
  }

  .category-card:hover h2 { color: var(--color-primary); }

  .category-desc {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.4;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.4rem;
  }

  .count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
</style>
