---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getUniqueTags, slugify } from '@utils/helpers';

const posts = await getCollection('blog', ({ data }) => !data.draft);
const tags = getUniqueTags(posts);
const tagCounts = tags
  .map((tag) => ({
    name: tag,
    slug: slugify(tag),
    count: posts.filter((p) => p.data.tags.includes(tag)).length,
  }))
  .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));

// Umbrales dinámicos por percentil (escalan con el crecimiento del blog)
const counts = tagCounts.map((t) => t.count);
const sorted = [...counts].sort((a, b) => a - b);
const p33 = sorted[Math.floor(sorted.length * 0.33)];
const p66 = sorted[Math.floor(sorted.length * 0.66)];

const populares = tagCounts.filter((t) => t.count > p66);
const frecuentes = tagCounts.filter((t) => t.count <= p66 && t.count >= p33);
const ocasionales = tagCounts.filter((t) => t.count < p33);

const sections = [
  { id: 'populares', label: 'Populares', tags: populares, level: 3 },
  { id: 'frecuentes', label: 'Frecuentes', tags: frecuentes, level: 2 },
  { id: 'ocasionales', label: 'Ocasionales', tags: ocasionales, level: 1 },
].filter((s) => s.tags.length > 0);
---

<BaseLayout title="Etiquetas" description="Todas las etiquetas del blog">
  <section class="container page-section">
    <div class="page-header">
      <span class="meta-prompt">$ ls -la /etiquetas/ | sort -rn</span>
      <h1>Etiquetas</h1>
      <p class="subtitle">{tagCounts.length} etiquetas en {posts.length} artículos</p>
    </div>

    {
      sections.map((section) => (
        <div class="tags-section" id={section.id}>
          <h2 class={`section-title level-${section.level}`}>{section.label}</h2>
          <div class="tags-grid">
            {section.tags.map((tag) => (
              <a href={`/etiquetas/${tag.slug}`} class={`tag-card level-${section.level}`}>
                <span class="tag-name">{tag.name}</span>
                <span class="tag-count">[{tag.count}]</span>
              </a>
            ))}
          </div>
        </div>
      ))
    }
  </section>
</BaseLayout>

<style>
  .page-section {
    padding: 3rem 0 4rem;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .meta-prompt {
    display: block;
    color: var(--color-primary);
    font-size: 0.8125rem;
    margin-bottom: 0.5rem;
  }

  .page-header h1 {
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  /* Secciones */
  .tags-section {
    margin-bottom: 2.5rem;
  }

  .section-title {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .section-title::before {
    content: '## ';
    color: var(--color-text-muted);
    font-weight: 400;
  }

  .section-title.level-3::after,
  .section-title.level-2::after {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    margin-left: 0.5rem;
    vertical-align: middle;
  }

  .section-title.level-3::after {
    background: #58d5a2;
  }

  .section-title.level-2::after {
    background: #00bfff;
  }

  /* Grid de tarjetas */
  .tags-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.75rem;
  }

  /* Tarjeta de tag */
  .tag-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.6rem 0.875rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-left-width: 3px;
    text-decoration: none;
    transition:
      background-color 0.2s,
      border-color 0.2s;
  }

  .tag-card.level-3 {
    border-left-color: #58d5a2;
  }

  .tag-card.level-2 {
    border-left-color: #00bfff;
  }

  .tag-card.level-1 {
    border-left-color: var(--color-border);
  }

  .tag-card:hover {
    background-color: color-mix(in srgb, var(--color-primary) 6%, transparent);
    border-color: var(--color-primary);
  }

  .tag-name {
    font-size: 0.8125rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--color-text);
    transition: color 0.2s;
  }

  .tag-card:hover .tag-name {
    color: var(--color-primary);
  }

  .tag-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    white-space: nowrap;
    transition: color 0.2s;
  }

  .tag-card:hover .tag-count {
    color: var(--color-primary);
  }
</style>
