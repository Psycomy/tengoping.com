# CI/CD Adicional — Plan de Implementación

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Añadir detección automática de enlaces rotos y tracking de calidad Lighthouse (accesibilidad, SEO, best practices) al pipeline de CI.

**Architecture:** Task 1 añade `linkinator` como devDependency con un script npm y un step en `ci.yml` que verifica enlaces internos del build. Task 2 añade un step Lighthouse CI (via `npx @lhci/cli`) con un fichero de configuración `.lighthouserc.json` que aserta thresholds mínimos sin incluir performance (demasiado inestable en CI). Cada task es independiente.

**Tech Stack:** GitHub Actions, linkinator (Node.js), @lhci/cli 0.15.1, Lighthouse

**Nota previa al implementador:** El ítem "sin caché de node_modules en CI" del análisis original es un **falso positivo** — `actions/setup-node@v4` con `cache: 'npm'` ya cachea `~/.npm` correctamente (línea 22 de `ci.yml`).

---

## Task 1: Detección de broken links con linkinator

Después del build, comprobar que todos los enlaces internos del sitio existen. `linkinator ./dist --recurse` arranca su propio servidor HTTP, rastreo desde la raíz y verifica cada href/src de los HTML generados. Con `--skip "^https?://(?!localhost)"` se omiten los enlaces externos (https:// y http:// a dominios externos) mientras se comprueban todos los internos servidos por localhost.

**Validación previa:** `npx linkinator ./dist --recurse --skip "^https?://(?!localhost)" --verbosity error` ya pasa en el estado actual — 466 links, 0 rotos, 3.85s.

**Files:**

- Modify: `package.json` (añadir devDependency + script)
- Modify: `.github/workflows/ci.yml` (añadir step tras Build)

**Step 1: Leer el estado actual**

```bash
grep -n "check-links\|linkinator" package.json
grep -n "check-links\|linkinator" .github/workflows/ci.yml
```

Expected: no aparece en ninguno de los dos archivos.

**Step 2: Instalar linkinator como devDependency**

```bash
cd /home/antonio/Documentos/blog && npm install --save-dev linkinator
```

Expected: `linkinator` aparece en `devDependencies` de `package.json`. Versión instalada ~7.x.

**Step 3: Añadir script `check-links` a `package.json`**

En `package.json`, dentro de `"scripts"`, añadir tras `"format:check"`:

```json
"check-links": "linkinator ./dist --recurse --skip \"^https?://(?!localhost)\" --verbosity error"
```

El bloque scripts completo quedaría similar a:

```json
"scripts": {
  "dev": "astro dev",
  "build": "astro build && node scripts/postbuild.mjs",
  "preview": "astro preview",
  "astro": "astro",
  "lint": "eslint .",
  "lint:fix": "eslint . --fix",
  "format": "prettier --write .",
  "format:check": "prettier --check .",
  "check-links": "linkinator ./dist --recurse --skip \"^https?://(?!localhost)\" --verbosity error"
}
```

**Step 4: Verificar el script localmente**

```bash
cd /home/antonio/Documentos/blog && npm run check-links 2>&1 | tail -5
```

Expected: `✓ Successfully scanned NNN links in N.NN seconds.` sin errores. Si hay errores, son enlaces rotos reales que hay que corregir antes de continuar.

**Step 5: Añadir step al CI**

En `.github/workflows/ci.yml`, añadir tras el step `Build` (al final del fichero):

```yaml
- name: Check internal links
  run: npm run check-links
```

El fichero `ci.yml` completo quedaría:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Lint, Check & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --omit=dev --audit-level=moderate

      - name: Type check
        run: npx astro check

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Build
        run: npm run build

      - name: Check internal links
        run: npm run check-links
```

**Step 6: Verificar lint y formato**

```bash
cd /home/antonio/Documentos/blog && npm run lint && npm run format:check
```

Expected: 0 errores. Si `package.json` falló el check de formato, ejecutar `npm run format` y volver a verificar.

**Step 7: Commit**

```bash
cd /home/antonio/Documentos/blog
git add package.json package-lock.json .github/workflows/ci.yml
git commit -m "ci: añadir detección de broken links con linkinator"
```

---

## Task 2: Lighthouse CI — tracking de accesibilidad, SEO y best practices

Ejecutar Lighthouse contra el sitio construido en cada CI run y fallar si los scores de accesibilidad, SEO o best practices caen por debajo de los umbrales mínimos. La performance se excluye de las aserciones porque es inherentemente inestable en entornos CI (variaciones de ±10-15 puntos entre runs son normales).

`@lhci/cli` con `staticDistDir: "./dist"` arranca su propio servidor interno — no necesita `npm run preview`. Se usa `npx @lhci/cli@0.15` en CI sin añadirlo a devDependencies (evita inflar `npm ci` con Lighthouse + dependencias pesadas).

**Files:**

- Create: `.lighthouserc.json`
- Modify: `.github/workflows/ci.yml` (añadir step tras Check internal links)

**Step 1: Crear `.lighthouserc.json`**

Crear en la raíz del proyecto `/home/antonio/Documentos/blog/.lighthouserc.json`:

```json
{
  "ci": {
    "collect": {
      "staticDistDir": "./dist",
      "numberOfRuns": 1,
      "url": ["/", "/blog/"],
      "settings": {
        "preset": "desktop",
        "skipAudits": ["uses-http2", "redirects-http", "uses-long-cache-ttl"]
      }
    },
    "assert": {
      "assertions": {
        "categories:accessibility": ["error", { "minScore": 0.85 }],
        "categories:seo": ["error", { "minScore": 0.85 }],
        "categories:best-practices": ["error", { "minScore": 0.8 }]
      }
    },
    "upload": {
      "target": "temporary-public-storage"
    }
  }
}
```

Notas sobre la configuración:

- `staticDistDir: "./dist"` — LHCI sirve la carpeta dist directamente (sin servidor externo)
- `numberOfRuns: 1` — una sola medición (performance excluida de aserciones, no necesita promedio)
- `url: ["/", "/blog/"]` — comprueba la home y el listado del blog
- `preset: "desktop"` — más estable que mobile en CI
- `skipAudits`:
  - `uses-http2` — requiere servidor real con HTTP/2; falla siempre en localhost
  - `redirects-http` — requiere HTTPS real; falla en localhost
  - `uses-long-cache-ttl` — los assets con hash (`/_astro/*`) tienen TTL correcto en Cloudflare pero Lighthouse no puede verificarlo en localhost
- `categories:performance` — **deliberadamente excluido de aserciones** (inestable en CI)
- `upload.target: "temporary-public-storage"` — guarda el reporte Lighthouse en LHCI temporal (público, 7 días), el output del step incluye una URL para ver el reporte

**Step 2: Verificar sintaxis del JSON**

```bash
node -e "JSON.parse(require('fs').readFileSync('.lighthouserc.json', 'utf8')); console.log('JSON válido')"
```

Expected: `JSON válido`

**Step 3: Añadir step al CI**

En `.github/workflows/ci.yml`, añadir tras `Check internal links`:

```yaml
- name: Lighthouse CI
  run: npx @lhci/cli@0.15 autorun
  env:
    LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
```

Nota sobre `LHCI_GITHUB_APP_TOKEN`: es opcional y solo se usa si se tiene el LHCI GitHub App instalado para añadir status checks en PRs. Sin el secret configurado, la variable estará vacía y LHCI simplemente omitirá esa integración. El step funciona igual.

El fichero `ci.yml` completo quedaría:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Lint, Check & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --omit=dev --audit-level=moderate

      - name: Type check
        run: npx astro check

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Build
        run: npm run build

      - name: Check internal links
        run: npm run check-links

      - name: Lighthouse CI
        run: npx @lhci/cli@0.15 autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
```

**Step 4: Verificar formato del fichero JSON con Prettier**

```bash
cd /home/antonio/Documentos/blog && npx prettier --check ".lighthouserc.json"
```

Si falla: `npx prettier --write ".lighthouserc.json"`

**Step 5: Verificar lint y formato general**

```bash
cd /home/antonio/Documentos/blog && npm run lint && npm run format:check
```

Expected: 0 errores.

**Step 6: Commit**

```bash
cd /home/antonio/Documentos/blog
git add .lighthouserc.json .github/workflows/ci.yml
git commit -m "ci: añadir Lighthouse CI — tracking accesibilidad, SEO y best practices"
```

---

## Verificación Final

Después de ambos commits:

```bash
# Build limpio
npm run build

# Verificar enlaces (debe pasar)
npm run check-links

# Verificar lint
npm run lint

# Ver los últimos commits
git log --oneline -4
```

Expected:

- `check-links` pasa sin errores
- Lint 0 errores
- 2 commits nuevos presentes

**Nota sobre el primer CI run de Lighthouse:** Si el step de Lighthouse falla en el primer push (scores por debajo de los umbrales), revisar el reporte en la URL que imprime el step (`temporary-public-storage`) y ajustar los umbrales en `.lighthouserc.json` según las puntuaciones reales. Los umbrales actuales (0.85/0.85/0.80) son conservadores pero pueden necesitar ajuste si el CI runner es lento.
